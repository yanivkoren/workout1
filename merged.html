<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>אימון: תרגילים + טיימר</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <style>
    body { background:#f7f7f9; }
    .timer-card { position: sticky; top: 16px; }
    .timer-display { font-size: 72px; line-height:1; color:#0d6efd; font-weight:700; }
    .btn-wide { min-width: 110px; }
    .hint { font-size: 0.9rem; color:#6c757d; }
    table.table { cursor: pointer; }
    .modal-img { width:100%; height:100%; object-fit:contain; }
    .modal-body { padding:0; height:65vh; display:flex; align-items:center; justify-content:center; background:#000; }
    .badge-rounds { font-size: .9rem; }
  </style>
</head>
<body class="py-4">
  <div class="container">
    <div class="row g-4">
      <!-- שמאל: טבלת תרגילים -->
      <div class="col-lg-7">
        <h2 class="mb-3">רשימת תרגילים</h2>
        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover table-bordered text-center align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>שריר</th>
                    <th>שם תרגיל</th>
                    <th>זמן/חזרות</th>
                    <th>הוראות ביצוע</th>
                  </tr>
                </thead>
                <tbody id="exerciseTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <p class="hint mt-2">טיפ: אפשר להוסיף עוד תרגילים במערך JS למטה, או לטעון JSON חיצוני בהמשך.</p>
      </div>

      <!-- ימין: טיימר -->
      <div class="col-lg-5">
        <div class="card timer-card shadow-sm">
          <div class="card-body">
            <h2 class="mb-2">טיימר אימון</h2>
            <div id="timerDisplay" class="timer-display text-center my-3">0</div>

            <div class="d-flex flex-wrap gap-2 justify-content-center mb-3">
              <button class="btn btn-primary btn-wide" onclick="startTimer(1)">1 שנייה</button>
              <button class="btn btn-primary btn-wide" onclick="startTimer(3)">3 שניות</button>
              <button class="btn btn-primary btn-wide" onclick="startTimer(5)">5 שניות</button>
              <button class="btn btn-primary btn-wide" onclick="startTimer(10)">10 שניות</button>
            </div>

            <div class="d-flex flex-wrap gap-2 justify-content-center mb-3">
              <button class="btn btn-warning btn-wide" id="pauseBtn" onclick="togglePause()">PAUSE</button>
              <button class="btn btn-danger btn-wide" onclick="resetTimer()">RESET</button>
            </div>

            <hr>

            <div class="d-flex flex-column align-items-center gap-2">
              <div id="suggestWrap" class="text-center d-none">
                <span class="badge text-bg-info me-1" id="suggestSeconds">משך מוצע: —</span>
                <span class="badge text-bg-secondary badge-rounds" id="suggestRounds">סטים: 1</span>
              </div>
              <button id="startSuggestedBtn" class="btn btn-success d-none" onclick="startSuggested()">
                התחל לפי התרגיל הנבחר
              </button>
              <p class="hint mb-0 mt-2">קיצורי מקלדת: Space = Pause/Resume, R = Reset</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal GIF -->
  <div class="modal fade" id="gifModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-dark">
        <div class="modal-header border-0">
          <h5 class="modal-title text-white" id="modalTitle">הדגמת תרגיל</h5>
          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="סגור"></button>
        </div>
        <div class="modal-body">
          <img id="modalImage" class="modal-img" src="" alt="תמונה של התרגיל">
        </div>
      </div>
    </div>
  </div>

  <!-- צליל סיום -->
  <audio id="beep" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== נתוני דוגמה (כמו בקובץ התרגילים) =====
    const exercises = [
      {
        muscle: "המסטרינג",
        name: "מתיחת ירך אחורית בישיבה",
        timeReps: "30 שניות × 2",
        instructions: "שב עם רגל אחת ישרה, התכופף קדימה והושט יד לעבר כף הרגל",
        image: "https://www.inspireusafoundation.org/file/2023/09/seated-hamstring-stretch.gif"
      },
      {
        muscle: "חזה",
        name: "Doorway Stretch",
        timeReps: "30 שניות × 2",
        instructions: "ידיים על משקוף מעל קו הכתפיים, צעד קדימה, חזה קדימה ולמעלה",
        image: "https://www.spotebi.com/wp-content/uploads/2015/01/doorway-stretch-exercise-illustration.jpg"
      },
      {
        muscle: "שוק אחורי",
        name: "Calf Stretch",
        timeReps: "45 שניות × 1",
        instructions: "עמידת מכרע מול קיר, עקב אחורי צמוד לרצפה",
        image: "https://www.inspireusafoundation.org/file/2022/12/wall-calf-stretch.gif"
      },
      {
        muscle: "כתפיים",
        name: "Shoulder Rolls",
        timeReps: "20 שניות × 3",
        instructions: "סובב כתפיים בתנועה איטית ומבוקרת",
        image: "https://www.inspireusafoundation.org/file/2023/03/shoulder-rolls.gif"
      },
      {
        muscle: "גב עליון",
        name: "Scapular Retraction",
        timeReps: "12 שניות × 4",
        instructions: "משוך שכמות לאחור וקרב אותן זו לזו",
        image: "https://www.inspireusafoundation.org/file/2023/11/scapular-retraction-exercise.gif"
      }
    ];

    // ===== בניית הטבלה + קליק לשילוב GIF+טיימר =====
    const tbody = document.getElementById("exerciseTableBody");
    let suggestedSeconds = null;
    let suggestedRounds = 1;

    exercises.forEach((ex) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ex.muscle}</td>
        <td>${ex.name}</td>
        <td>${ex.timeReps}</td>
        <td>${ex.instructions}</td>
      `;
      tr.addEventListener("click", () => {
        // עדכון פופאפ
        document.getElementById("modalImage").src = ex.image;
        document.getElementById("modalTitle").textContent = `הדגמת תרגיל: ${ex.name}`;
        new bootstrap.Modal(document.getElementById("gifModal")).show();

        // חישוב משך מוצע/סטים מהשדה "זמן/חזרות"
        const { seconds, rounds } = parseTimeReps(ex.timeReps);
        suggestedSeconds = seconds;
        suggestedRounds  = rounds;

        // הצגה בלוח הטיימר
        document.getElementById("suggestSeconds").textContent = `משך מוצע: ${seconds} שניות`;
        document.getElementById("suggestRounds").textContent  = `סטים: ${rounds}`;
        document.getElementById("suggestWrap").classList.remove("d-none");
        document.getElementById("startSuggestedBtn").classList.remove("d-none");
      });
      tbody.appendChild(tr);
    });

    function parseTimeReps(str) {
      // מחלץ את הספרה הראשונה בשניות, ואת ה"× N" אם קיים
      const secsMatch = str.match(/(\d+)\s*שנ/); // "30 שניות"
      const multMatch = str.match(/[×xX]\s*(\d+)/); // "× 2"
      const seconds = secsMatch ? parseInt(secsMatch[1], 10) : 30;
      const rounds  = multMatch ? parseInt(multMatch[1], 10) : 1;
      return { seconds, rounds };
    }

    // ===== טיימר: Pause/Resume/Reset + ריצת סטים ברצף =====
    let countdown = null;
    let timeLeft = 0;
    let isPaused = false;
    let isRunning = false;
    let remainingRounds = 1;

    function startTimer(seconds, rounds = 1) {
      resetTimer(); // איפוס מוחלט קודם
      remainingRounds = Math.max(1, rounds);
      timeLeft = seconds;
      isPaused = false;
      isRunning = true;
      updateDisplay(timeLeft);
      document.getElementById("pauseBtn").textContent = "PAUSE";

      countdown = setInterval(() => {
        if (!isPaused && isRunning) {
          timeLeft--;
          updateDisplay(timeLeft);

          if (timeLeft <= 0) {
            // סוף סט
            playBeep();
            clearInterval(countdown);
            countdown = null;
            remainingRounds--;

            if (remainingRounds > 0) {
              // התחלת סט נוסף אוטומטית לאחר השהייה קצרה
              setTimeout(() => {
                if (!isRunning) return; // אם נעצר בינתיים
                timeLeft = seconds;
                updateDisplay(timeLeft);
                countdown = setInterval(tick, 1000);
              }, 800);
            } else {
              // סיום כל הסטים
              isRunning = false;
              document.getElementById("pauseBtn").textContent = "PAUSE";
              document.getElementById("timerDisplay").textContent = "✔️";
            }
          }
        }
      }, 1000);

      function tick() {
        if (!isPaused && isRunning) {
          timeLeft--;
          updateDisplay(timeLeft);
          if (timeLeft <= 0) {
            playBeep();
            clearInterval(countdown);
            countdown = null;
            remainingRounds--;
            if (remainingRounds > 0) {
              setTimeout(() => {
                if (!isRunning) return;
                timeLeft = seconds;
                updateDisplay(timeLeft);
                countdown = setInterval(tick, 1000);
              }, 800);
            } else {
              isRunning = false;
              document.getElementById("pauseBtn").textContent = "PAUSE";
              document.getElementById("timerDisplay").textContent = "✔️";
            }
          }
        }
      }
    }

    function startSuggested() {
      if (suggestedSeconds == null) return;
      startTimer(suggestedSeconds, suggestedRounds);
    }

    function togglePause() {
      if (!isRunning) return;
      isPaused = !isPaused;
      document.getElementById("pauseBtn").textContent = isPaused ? "RESUME" : "PAUSE";
    }

    function resetTimer() {
      if (countdown !== null) { clearInterval(countdown); countdown = null; }
      isPaused = false;
      isRunning = false;
      timeLeft = 0;
      remainingRounds = 1;
      updateDisplay(0);
      document.getElementById("pauseBtn").textContent = "PAUSE";
      stopBeep();
    }

    function updateDisplay(v) {
      document.getElementById("timerDisplay").textContent = v;
    }

    function playBeep() {
      const beep = document.getElementById("beep");
      beep.pause();
      beep.currentTime = 0;
      beep.play().catch(()=>{});
    }

    function stopBeep() {
      const beep = document.getElementById("beep");
      beep.pause();
      beep.currentTime = 0;
    }

    // קיצורי מקלדת: Space=Pause/Resume, R=Reset
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") { e.preventDefault(); togglePause(); }
      if (e.key.toLowerCase() === "r") { resetTimer(); }
    });
  </script>
</body>
</html>
